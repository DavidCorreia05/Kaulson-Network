<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kaulson Network | Protocolo</title>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, limit, where, getDocs, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA51GrwiUnvZVbv4Cvz-M", 
        authDomain: "kaulson-network.firebaseapp.com",
        projectId: "kaulson-network",
        storageBucket: "kaulson-network.firebasestorage.app",
        messagingSenderId: "756558405529",
        appId: "1:756558405529:web:999f6fa"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      let userId = localStorage.getItem('kson_id_v14') || 'KSON_' + Math.floor(Math.random() * 89999 + 10000);
      localStorage.setItem('kson_id_v14', userId);

      const refBy = new URLSearchParams(window.location.search).get('ref');
      if(refBy && refBy !== userId && !localStorage.getItem('kson_ref_v14')) {
          localStorage.setItem('kson_ref_v14', refBy);
      }

      window.getStats = async () => {
          const coll = collection(db, "kaulson_v14");
          const totalUsers = (await getCountFromServer(coll)).data().count;
          let rate = 2.0;
          if(totalUsers > 100000) rate = 1.0;
          if(totalUsers > 500000) rate = 0.5;

          const q = query(coll, where("invitedBy", "==", userId), where("isMining", "==", true));
          const bonus = (await getDocs(q)).size * 0.25;
          return (rate * (1 + bonus)) / 3600;
      };

      window.sync = async (s, m) => {
          await setDoc(doc(db, "kaulson_v14", userId), {
              id: userId, saldo: s, isMining: m, last: Date.now(), 
              invitedBy: localStorage.getItem('kson_ref_v14') || ""
          }, { merge: true });
      };

      onSnapshot(query(collection(db, "kaulson_v14"), orderBy("saldo", "desc"), limit(5)), (snap) => {
          const list = document.getElementById('rankList');
          list.innerHTML = "";
          snap.forEach(d => {
              const u = d.data();
              list.innerHTML += `<div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #222;">
                  <span style="${u.id===userId?'color:#d4af37':''}">${u.id===userId?'VOC√ä':u.id}</span>
                  <b>${u.saldo.toFixed(5)}</b>
              </div>`;
          });
      });
    </script>

    <style>
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; text-align: center; margin: 0; }
        .header { padding: 40px 20px; border-bottom: 1px solid #222; }
        .bal { font-size: 50px; font-weight: bold; color: #d4af37; }
        .k-btn { width: 180px; height: 180px; border-radius: 50%; border: 8px solid #222; background: #d4af37; font-size: 75px; font-weight: bold; cursor: pointer; margin: 25px 0; transition: 0.2s; }
        .k-btn.active { background: #111; color: #d4af37; border-color: #d4af37; box-shadow: 0 0 20px rgba(212,175,55,0.3); }
        .card { background: #111; margin: 15px; padding: 15px; border-radius: 12px; text-align: left; border: 1px solid #222; }
        .btn-action { background: #d4af37; color: #000; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .rules { font-size: 13px; color: #999; line-height: 1.6; }
        .rules b { color: #d4af37; }
    </style>
</head>
<body>

    <div class="header">
        <div style="font-size: 10px; color: #555; letter-spacing: 2px;">KAULSON NETWORK</div>
        <div class="bal" id="visor">0.00000</div>
        <div id="speed" style="color: #d4af37; font-size: 12px; margin-top: 5px;">A calcular rede...</div>
    </div>

    <button class="k-btn" id="btn">K</button>

    <div class="card">
        <div id="status" style="font-weight: bold; font-size: 11px; color: #ff4444;">INATIVO</div>
        <div id="timer" style="font-size: 20px; margin-top: 3px; font-weight: bold;">Clique para validar presen&ccedil;a</div>
    </div>

    <div class="card">
        <b style="color:#d4af37;">üìú PROTOCOLO DE ESCASSEZ ($KSON)</b>
        <div class="rules" style="margin-top:10px;">
            1. <b>Halving:</b> De 0-100k users: 2.0/h. De 100k-500k: 1.0/h. De 500k-1M: 0.5/h.<br>
            2. <b>Ciclo 24h:</b> √â obrigat√≥rio validar a presen√ßa a cada 24 horas.<br>
            3. <b>Referral:</b> +25% de b√≥nus por cada amigo ativo convidado.<br>
            4. <b>Cofre:</b> Aos 90.000.000 $KSON, a minera√ß√£o para para sempre.<br>
            5. <b>Seguran√ßa:</b> Multi-contas no mesmo dispositivo ser√£o bloqueadas.
        </div>
        <button class="btn-action" id="copy">COPIAR MEU LINK DE CONVITE</button>
    </div>

    <div class="card">
        <b style="color:#d4af37; font-size: 12px;">üèÜ RANKING G&Eacute;NESIS</b>
        <div id="rankList" style="margin-top:10px; font-size: 14px;">A carregar...</div>
    </div>

    <script>
        let balance = parseFloat(localStorage.getItem('kson_v14_bal')) || 0;
        let last = parseInt(localStorage.getItem('kson_v14_last')) || 0;
        let rps = 2.0 / 3600;
        const cycle = 24 * 60 * 60 * 1000;

        async function init() {
            if (window.getStats) rps = await window.getStats();
            document.getElementById('speed').innerText = `Velocidade Atual: ${(rps * 3600).toFixed(2)} $KSON/h`;
        }

        function loop() {
            const now = Date.now();
            if (last > 0 && (now - last) < cycle) {
                balance += rps;
                document.getElementById('visor').innerText = balance.toFixed(5);
                localStorage.setItem('kson_v14_bal', balance);
                
                const rem = cycle - (now - last);
                const h = Math.floor(rem/3600000), m = Math.floor((rem%3600000)/60000), s = Math.floor((rem%60000)/1000);
                document.getElementById('status').innerText = "MINERA√á√ÉO ATIVA";
                document.getElementById('status').style.color = "#00ff00";
                document.getElementById('timer').innerText = `${h}h ${m}m ${s}s`;
                document.getElementById('btn').classList.add('active');
                document.getElementById('btn').innerText = "‚õèÔ∏è";

                if (Math.floor(now/1000) % 20 === 0 && window.sync) window.sync(balance, true);
            } else {
                document.getElementById('status').innerText = "INATIVO";
                document.getElementById('status').style.color = "#ff4444";
                document.getElementById('timer').innerText = "Toque para validar (24h)";
                document.getElementById('btn').classList.remove('active');
                document.getElementById('btn').innerText = "K";
            }
        }

        document.getElementById('btn').onclick = () => {
            if (Date.now() - last >= cycle || last === 0) {
                last = Date.now();
                localStorage.setItem('kson_v14_last', last);
                init();
            }
        };

        document.getElementById('copy').onclick = () => {
            const link = `${window.location.origin}${window.location.pathname}?ref=${localStorage.getItem('kson_id_v14')}`;
            navigator.clipboard.writeText(link).then(() => alert("Link oficial copiado!"));
        };

        setInterval(loop, 1000);
        setTimeout(init, 2000);
    </script>
</body>
</html>
